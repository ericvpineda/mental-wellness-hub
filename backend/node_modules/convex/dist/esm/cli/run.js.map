{
  "version": 3,
  "sources": ["../../../src/cli/run.ts"],
  "sourcesContent": ["import { Command, Option } from \"@commander-js/extra-typings\";\nimport { logFailure, oneoffContext } from \"../bundler/context.js\";\nimport { watchAndPush } from \"./dev.js\";\nimport {\n  fetchDeploymentCredentialsProvisionProd,\n  deploymentSelectionFromOptions,\n} from \"./lib/api.js\";\nimport { actionDescription } from \"./lib/command.js\";\nimport { runFunctionAndLog, subscribeAndLog } from \"./lib/run.js\";\nimport { ensureHasConvexDependency } from \"./lib/utils.js\";\n\nexport const run = new Command(\"run\")\n  .description(\"Run a function (query, mutation, or action) on your deployment\")\n  .argument(\n    \"functionName\",\n    \"identifier of the function to run, like `listMessages` or `dir/file:myFunction`\",\n  )\n  .argument(\n    \"[args]\",\n    \"JSON-formatted arguments object to pass to the function.\",\n  )\n  .option(\n    \"-w, --watch\",\n    \"Watch a query, printing its result if the underlying data changes. Given function must be a query.\",\n  )\n  .option(\"--push\", \"Push code to deployment before running the function.\")\n  // For backwards compatibility we still support --no-push which is a noop\n  .addOption(new Option(\"--no-push\").hideHelp())\n  .addDeploymentSelectionOptions(actionDescription(\"Run the function on\"))\n  // Options for the implicit dev deploy\n  .addOption(\n    new Option(\n      \"--typecheck <mode>\",\n      `Whether to check TypeScript files with \\`tsc --noEmit\\`.`,\n    )\n      .choices([\"enable\", \"try\", \"disable\"] as const)\n      .default(\"try\" as const),\n  )\n  .addOption(\n    new Option(\"--codegen <mode>\", \"Regenerate code in `convex/_generated/`\")\n      .choices([\"enable\", \"disable\"] as const)\n      .default(\"enable\" as const),\n  )\n\n  .showHelpAfterError()\n  .action(async (functionName, argsString, options) => {\n    const ctx = oneoffContext;\n\n    const deploymentSelection = deploymentSelectionFromOptions(options);\n\n    const {\n      adminKey,\n      url: deploymentUrl,\n      deploymentType,\n    } = await fetchDeploymentCredentialsProvisionProd(ctx, deploymentSelection);\n\n    await ensureHasConvexDependency(ctx, \"run\");\n\n    const args = argsString ? JSON.parse(argsString) : {};\n\n    if (deploymentType === \"prod\" && options.push) {\n      logFailure(\n        ctx,\n        `\\`convex run\\` doesn't support pushing functions to prod deployments. ` +\n          `Remove the --push flag. To push to production use \\`npx convex deploy\\`.`,\n      );\n      return await ctx.crash(1, \"fatal\");\n    }\n\n    if (options.push) {\n      await watchAndPush(\n        ctx,\n        {\n          adminKey,\n          verbose: false,\n          dryRun: false,\n          typecheck: options.typecheck,\n          debug: false,\n          codegen: options.codegen === \"enable\",\n          url: deploymentUrl,\n        },\n        {\n          once: true,\n          traceEvents: false,\n          untilSuccess: true,\n        },\n      );\n    }\n\n    if (options.watch) {\n      return await subscribeAndLog(\n        ctx,\n        deploymentUrl,\n        adminKey,\n        functionName,\n        args,\n      );\n    }\n    return await runFunctionAndLog(\n      ctx,\n      deploymentUrl,\n      adminKey,\n      functionName,\n      args,\n    );\n  });\n"],
  "mappings": ";AAAA,SAAS,SAAS,cAAc;AAChC,SAAS,YAAY,qBAAqB;AAC1C,SAAS,oBAAoB;AAC7B;AAAA,EACE;AAAA,EACA;AAAA,OACK;AACP,SAAS,yBAAyB;AAClC,SAAS,mBAAmB,uBAAuB;AACnD,SAAS,iCAAiC;AAEnC,aAAM,MAAM,IAAI,QAAQ,KAAK,EACjC,YAAY,gEAAgE,EAC5E;AAAA,EACC;AAAA,EACA;AACF,EACC;AAAA,EACC;AAAA,EACA;AACF,EACC;AAAA,EACC;AAAA,EACA;AACF,EACC,OAAO,UAAU,sDAAsD,EAEvE,UAAU,IAAI,OAAO,WAAW,EAAE,SAAS,CAAC,EAC5C,8BAA8B,kBAAkB,qBAAqB,CAAC,EAEtE;AAAA,EACC,IAAI;AAAA,IACF;AAAA,IACA;AAAA,EACF,EACG,QAAQ,CAAC,UAAU,OAAO,SAAS,CAAU,EAC7C,QAAQ,KAAc;AAC3B,EACC;AAAA,EACC,IAAI,OAAO,oBAAoB,yCAAyC,EACrE,QAAQ,CAAC,UAAU,SAAS,CAAU,EACtC,QAAQ,QAAiB;AAC9B,EAEC,mBAAmB,EACnB,OAAO,OAAO,cAAc,YAAY,YAAY;AACnD,QAAM,MAAM;AAEZ,QAAM,sBAAsB,+BAA+B,OAAO;AAElE,QAAM;AAAA,IACJ;AAAA,IACA,KAAK;AAAA,IACL;AAAA,EACF,IAAI,MAAM,wCAAwC,KAAK,mBAAmB;AAE1E,QAAM,0BAA0B,KAAK,KAAK;AAE1C,QAAM,OAAO,aAAa,KAAK,MAAM,UAAU,IAAI,CAAC;AAEpD,MAAI,mBAAmB,UAAU,QAAQ,MAAM;AAC7C;AAAA,MACE;AAAA,MACA;AAAA,IAEF;AACA,WAAO,MAAM,IAAI,MAAM,GAAG,OAAO;AAAA,EACnC;AAEA,MAAI,QAAQ,MAAM;AAChB,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,QACE;AAAA,QACA,SAAS;AAAA,QACT,QAAQ;AAAA,QACR,WAAW,QAAQ;AAAA,QACnB,OAAO;AAAA,QACP,SAAS,QAAQ,YAAY;AAAA,QAC7B,KAAK;AAAA,MACP;AAAA,MACA;AAAA,QACE,MAAM;AAAA,QACN,aAAa;AAAA,QACb,cAAc;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,QAAQ,OAAO;AACjB,WAAO,MAAM;AAAA,MACX;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACA,SAAO,MAAM;AAAA,IACX;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF,CAAC;",
  "names": []
}
